---
title:    "Risk of Business Failure - Question A.ctd"
students: F.Gemignani, S.Cucchi, F.Falleni
output:   aida-qa-ctd.nb.html
---

Setup
```{r}
library(skimr)  
library(ggplot2)
library(hrbrthemes)   
library(forcats)  

# clean all
rm(list=ls())

# working dir
wdir_fg = "/Users/francescogemignani/Google Drive/SMD/_Risk-of-business-failure/git"
wdir_ff = "C:/Users/falle/Documents/GitHub/Risk-of-Business-Failure"
wdir_sc = "/Users/samuele/University/2.SMD/Risk-of-Business-Failure"
setwd(wdir_ff)
```

*########################################## QUESTION A CTD ################################################*
*A.ctd Compare the distributions of age/size/roi of failed companies over time*
*A.1.ctd Does it change for a specific company form (i.e. SPA,SRL,etc)?*
*A.2.ctd Does it change for a specific location (i.e. Tuscany,Lombardy,etc.)?*
*##########################################################################################################*

*###############*
*##### AGE #####*
*###############*

Company ages summary
```{r}
# import age dcompany ata
load("./dataset/aida.age.RData") 
aida <- aida.age
rm(aida.age)

#summary
skim(aida)

#dataset
head(aida)
```

Filter ages of failed company for an interval of year
```{r}
# Filtering ages of all failed companies
aida.failed <- aida[aida$Failed=='Yes',]

# We compare the distribution of age with failed companies over two years
table(aida.failed$Last.accounting.closing.date)

# Filtering ages of all failed companies over years
aida.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 | aida.failed$Last.accounting.closing.date == 2018 ,]

rm(aida)
```

Density of Age of Failed Companies Over Years selected
```{r}
# density of age of failed companies over years selected
ggplot(data=aida.failed, aes(x=Age, group=as.factor(Last.accounting.closing.date), fill=as.factor(Last.accounting.closing.date))) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Ages of Failed Companies Over Time")

```

A.ctd Compare the distributions of AGE of failed companies over selected years
```{r}
age.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017,'Age']
age.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018,'Age']

t.test(age.y1.failed,age.y2.failed)
t.test(age.y1.failed,age.y2.failed,alternative = 'less')
t.test(age.y1.failed,age.y2.failed,alternative = 'greater')

# Remove data from stack
rm(age.y1.failed,age.y2.failed)

# RISULTATO: H0 non significative p-value molto basso. Considero l'ipotesi bilaterale maggiore con p-value = 1
# La media dell'età delle aziende fallite nel 2017 è superiore alla media dell'età delle aziende fallite nel 2018.
# Quindi le aziende fallite nel 2017 sono più vecchie di quelle fallite nel 2018.
```

A.1.ctd Does AGE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.failed$Legal.form)

table(aida.failed$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  age.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & aida.failed$Legal.form==form.name ,'Age']
  age.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & aida.failed$Legal.form==form.name ,'Age']
  
  if( length(age.y1.failed)>3 & length(age.y2.failed)>3 ){
    print(t.test(age.y1.failed,age.y2.failed))
    print(t.test(age.y1.failed,age.y2.failed,alternative = 'less'))
    print(t.test(age.y1.failed,age.y2.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.y1.failed,age.y2.failed)
}

# RISULTATI
```

A.2.ctd Does AGE change for a specific location (i.e. Tuscany,Lombardy,etc.)?
```{r}
# List of unique legal form values
company.regions <- unique(aida.failed$Registered.office.address...Region)
table(aida.failed$Registered.office.address...Region)

for(region.name in company.regions){
  print("**************************")
  print(region.name)
  age.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & 
                                     aida.failed$Registered.office.address...Region==region.name ,'Age']
  age.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & 
                                     aida.failed$Registered.office.address...Region==region.name ,'Age']
  
  if( length(age.y1.failed)>3 & length(age.y2.failed)>3 ){
    print(t.test(age.y1.failed,age.y2.failed))
    print(t.test(age.y1.failed,age.y2.failed,alternative = 'less'))
    print(t.test(age.y1.failed,age.y2.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.y1.failed,age.y2.failed)
}

rm(aida.failed)
# RISULTATI
```




*##############*
*#### SIZE ####*
*##############*

```{r}
# import roi dcompany ata
load("./dataset/aida.size.RData") 
aida <- aida.size
rm(aida.size)

#summary
skim(aida)

#dataset
head(aida)

```

Filter SIZE of failed company for an interval of years 
```{r}
# Filtering ages of all failed companies
aida.failed <- aida[aida$Failed=='Yes',]

# We compare the distribution of size with failed companies over two years
table(aida.failed$Last.accounting.closing.date)

# Filtering sizes of all failed companies over two selected years
aida.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 | aida.failed$Last.accounting.closing.date == 2018 ,]

#names(aida.failed)[names(aida.failed) == "Total.assetsth.EURLast.avail..yr"] <- "Size"
rm(aida)
```

Density of SIZE of failed companier over selected years
```{r}
# density of size of failed companies over selected years
ggplot(data=aida.failed, aes(x=Total.assetsth.EURLast.avail..yr, group=as.factor(Last.accounting.closing.date), fill=as.factor(Last.accounting.closing.date))) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Size of Failed Companies Over Time")

```

A.ctd Compare the distributions of SIZE of failed companies over selected years
```{r}
size.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017,'Total.assetsth.EURLast.avail..yr']
size.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018,'Total.assetsth.EURLast.avail..yr']

t.test(size.y1.failed,size.y2.failed)
t.test(size.y1.failed,size.y2.failed,alternative = 'less')
t.test(size.y1.failed,size.y2.failed,alternative = 'greater')

# Remove data from stack
rm(size.y1.failed,size.y2.failed)

# RISULTATO
```

A.1.ctd Does SIZE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.failed$Legal.form)

table(aida.failed$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  size.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & aida.failed$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  size.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & aida.failed$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.y1.failed)>3 & length(size.y2.failed)>3 ){
    print(t.test(size.y1.failed, size.y2.failed))
    print(t.test(size.y1.failed, size.y2.failed, alternative = 'less'))
    print(t.test(size.y1.failed, size.y2.failed, alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.y1.failed, size.y2.failed)
}

# RISULTATI
```

A.2.ctd Does SIZE change for a specific location (i.e. Tuscany,Lombardy,etc.)?
```{r}
# List of unique legal form values
company.regions <- unique(aida.failed$`Registered.office.address.-.Region`)
table(aida.failed$`Registered.office.address.-.Region`)

for(region.name in company.regions){
  print("**************************")
  print(region.name)
  size.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & 
                                     aida.failed$`Registered.office.address.-.Region`==region.name ,'Total.assetsth.EURLast.avail..yr']
  size.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & 
                                     aida.failed$`Registered.office.address.-.Region`==region.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.y1.failed)>3 & length(size.y2.failed)>3 ){
    print(t.test(size.y1.failed,size.y2.failed))
    print(t.test(size.y1.failed,size.y2.failed,alternative = 'less'))
    print(t.test(size.y1.failed,size.y2.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.y1.failed,size.y2.failed)
}

# RISULTATI
```



*##############*
*#### ROI #####*
*##############*

```{r}
# import roi dcompany ata
load("./dataset/aida.roi.RData") 
aida <- aida.roi
rm(aida.roi)

#summary
skim(aida)

#dataset
head(aida)

```

Filter ROI of failed company for an interval of year
```{r}

# Filtering roi of all failed companies
aida.failed <- aida[aida$Failed=='Yes',]

# We compare the distribution of roi if failed companies over two years
table(aida.failed$Last.accounting.closing.date)

# Filtering roi of all failed companies over years
aida.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 | aida.failed$Last.accounting.closing.date == 2018 ,]

rm(aida)

```

Density of ROI of Failed Companies Over Years selected
```{r}
# density of roi of failed companies over years selected
ggplot(data=aida.failed, aes(x=`Return.on.investment.(ROI).(%)%Last.avail..yr`, group=as.factor(Last.accounting.closing.date), fill=as.factor(Last.accounting.closing.date))) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Roi of Failed Companies Over Time")

```

A.ctd Compare the distributions of ROI of failed companies over selected years
```{r}
roi.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017,'Return.on.investment.(ROI).(%)%Last.avail..yr']
roi.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018,'Return.on.investment.(ROI).(%)%Last.avail..yr']

t.test(roi.y1.failed, roi.y2.failed)
t.test(roi.y1.failed, roi.y2.failed, alternative = 'less')
t.test(roi.y1.failed, roi.y2.failed, alternative = 'greater')

# Remove data from stack
rm(roi.y1.failed,roi.y2.failed)

# RISULTATO: H0 non significative p-value molto basso. Considero l'ipotesi bilaterale maggiore con p-value = 1
# La media del roi delle aziende fallite nel 2017 è inferiore alla media del roi delle aziende fallite nel 2018.
# Quindi le aziende fallite nel 2017 hanno un roi inferiore di quelle fallite nel 2018.
```

A.1.ctd Does ROI change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.failed$Legal.form)

table(aida.failed$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  roi.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & aida.failed$Legal.form==form.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  roi.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & aida.failed$Legal.form==form.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  
  if( length(roi.y1.failed)>3 & length(roi.y2.failed)>3 ){
    print(t.test(roi.y1.failed, roi.y2.failed))
    print(t.test(roi.y1.failed, roi.y2.failed, alternative = 'less'))
    print(t.test(roi.y1.failed, roi.y2.failed, alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.y1.failed, roi.y2.failed)
}

# RISULTATI
```

A.2.ctd Does ROI change for a specific location (i.e. Tuscany,Lombardy,etc.)?
```{r}
# List of unique legal form values
company.regions <- unique(aida.failed$`Registered.office.address.-.Region`)
table(aida.failed$`Registered.office.address.-.Region`)

for(region.name in company.regions){
  print("**************************")
  print(region.name)
  roi.y1.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 & aida.failed$`Registered.office.address.-.Region`==region.name ,
                               'Return.on.investment.(ROI).(%)%Last.avail..yr']
  roi.y2.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2018 & aida.failed$`Registered.office.address.-.Region`==region.name ,
                               'Return.on.investment.(ROI).(%)%Last.avail..yr']
  
  if( length(roi.y1.failed)>3 & length(roi.y2.failed)>3 ){
    print(t.test(roi.y1.failed,roi.y2.failed))
    print(t.test(roi.y1.failed,roi.y2.failed,alternative = 'less'))
    print(t.test(roi.y1.failed,roi.y2.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.y1.failed,roi.y2.failed)
}

# RISULTATI
```







*################*
*#### PROVA #####*
*################*

```{r}

# Filtering ages of all failed companies
aida.failed <- aida[aida$Failed=='Yes',]

# We compare the distribution of age with failed companies over two years
table(aida.failed$Last.accounting.closing.date)

# Filtering ages of all failed companies over years
aida.failed <- aida.failed[aida.failed$Last.accounting.closing.date == 2017 | aida.failed$Last.accounting.closing.date == 2018 |
                                          aida.failed$Last.accounting.closing.date == 2016 | aida.failed$Last.accounting.closing.date == 2015,]


rm(aida)
```
*###############*
*##### AGE #####*
*###############*

A.ctd Compare the distributions of AGE of failed companies over selected years
```{r}
boxplot(Age~Last.accounting.closing.date, data=aida.failed)
```
```{r}
# req: normality (Shapiro test si può fare su al massimo 5000 sample)
tapply(aida.failed$Age[0:5000], aida.failed$Last.accounting.closing.date[0:5000], shapiro.test)
```
```{r}
#No normalità delle distribuzioni e quindi non è possibile effettuare ANOVA test

# Testing multiple samples: non-parametric test
# Package SCMAMP: see https://github.com/b0rxa/scmamp
# installation
if (!require("devtools")) {
  install.packages("devtools")
}
install.packages("cli")
devtools::install_github("b0rxa/scmamp")
library(scmamp)
```


```{r}
table(aida.failed$Last.accounting.closing.date)
```
```{r}
age.2015 = aida.failed[aida.failed$Last.accounting.closing.date==2015,]$Age[0:47000]
age.2016 = aida.failed[aida.failed$Last.accounting.closing.date==2016,]$Age[0:47000]
age.2017 = aida.failed[aida.failed$Last.accounting.closing.date==2017,]$Age[0:47000] 
age.2018 = aida.failed[aida.failed$Last.accounting.closing.date==2018,]$Age[0:47000]
```


```{r}
x <- data.frame("Age2015"=age.2015, "Age2016"=age.2016, "Age2017"=age.2017, "Age2018"=age.2018)
plotDensities(data=x, size=1.1)
```


```{r}
# Friedman non-parametric test
friedmanTest(x)
```
```{r}
# Post-hoc Nemenyi 
test = nemenyiTest(x, alpha=0.05)
test
```
```{r}
test$diff.matrix
abs(test$diff.matrix) > test$statistic # significant tests
```
```{r}
plotCD(x, alpha=0.05, cex=1.25)
```



ctd Does AGE change for a specific company form (i.e. SPA,SRL,etc)?

```{r}
boxplot(Age~Legal.form, data=aida.failed)
```


```{r}
# List of unique legal form values
#company.forms <- unique(aida.failed$Legal.form)

company.forms <- names(which(table(aida.failed$Legal.form) > 3000))
x <- data.frame("S.C.A.R.L."=c(1:3000))
for(form in company.forms){
  x[[form]] <- aida.failed[aida.failed$Legal.form==form,]$Age[0:3000]
}

plotDensities(data=x, size=1.1)

```

```{r}
friedmanTest(x)
```
```{r}
# Post-hoc Nemenyi 
test = nemenyiTest(x, alpha=0.05)
test
```

```{r}
test$diff.matrix
abs(test$diff.matrix) > test$statistic # significant tests
```

```{r}
plotCD(x, alpha=0.05, cex=1.25)
```

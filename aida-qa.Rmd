---
title:    "Risk of Business Failure - Question A"
students: F.Gemignani, S.Cucchi, F.Falleni
output:   aida-qa-ctd.nb.html
---

Setup
```{r}
library(skimr)  
library(ggplot2)
library(hrbrthemes)   
library(forcats)  

# clean all
rm(list=ls())

# working dir
wdir_fg = "/Users/francescogemignani/Google Drive/SMD/_Risk-of-business-failure/git"
wdir_ff = "C:/Users/falle/OneDrive - University of Pisa/Data Science/Statistical Methods for Data Science/smdproject2021"
wdir_sc = "/Users/samuele/University/2.SMD/Risk-of-Business-Failure"
setwd(wdir_fg)
```


*########################################## QUESTION A ################################################*
*A.  Compare the distributions of age/size/roi between failed and active companies at a specific year*
*A.1 Does it change for a specific company form (i.e. SPA,SRL,etc)?*
*A.2 Does it change for a specific industry sector (see ATECO sectors)?*
*######################################################################################################*

*###############*
*##### AGE #####*
*###############*
Company ages summary
```{r}
# import aida dataset
load("./dataset/aida.age.RData") # reload energy dataset

#summary
skim(aida.age)

#dataset
head(aida.age)
```

Filter ages of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare age because it has the highest number of samples
table(aida.age$Last.accounting.closing.date)

# Filtering
aida.age.yy <- aida.age[aida.age$Last.accounting.closing.date == 2018,]

rm(aida.age)
```

Some plots of Age in Year 2018
```{r}

##### AGE
# histogram of age between failed and active companies at year 2018
ggplot(data = aida.age.yy) + 
  geom_histogram(mapping=aes(x=Age, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed') + 
    ggtitle("Histogram of Company ages in 2018")

# density of age between failed and active companies at year 2018
ggplot(data=aida.age.yy, aes(x=Age, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company ages in 2018")

```

A. Compare the distributions of AGE between failed and active companies at a specific year (2018)
```{r}
age.yy.active <- aida.age.yy[aida.age.yy$Failed=='No','Age']
age.yy.failed <- aida.age.yy[aida.age.yy$Failed=='Yes','Age']

t.test(age.yy.active,age.yy.failed)
t.test(age.yy.active,age.yy.failed,alternative = 'less')
t.test(age.yy.active,age.yy.failed,alternative = 'greater')


# Remove data from stack
rm(age.yy.active,age.yy.failed)

# RISULTATO
# Il p-value dell'ipotesi nulla non è significativo perchè è molto basso. Di conseguenza scarto l'ipotesi nulle e considero solo quelle bilaterali, in particolare
# l'ipotesi bilateriale superiore. In tal caso il p-value è pari a 1, e questo ci porta ad accettare l'ipotesi bilaterale superiore, ovvero che la media dell'età
# dell'età delle aziende attive è superiore alla media delle età delle aziende fallite (nel 2018).  
# Quindi nel 2018 le aziende attive sono più vecchie di quelle fallite
```

A.1 Does AGE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.age.yy$Legal.form)
table(aida.age.yy$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  age.yy.active <- aida.age.yy[aida.age.yy$Failed=='No' & aida.age.yy$Legal.form==form.name ,'Age']
  age.yy.failed <- aida.age.yy[aida.age.yy$Failed=='Yes'& aida.age.yy$Legal.form==form.name ,'Age']
  
  if( length(age.yy.active)>3 & length(age.yy.failed)>3 ){
    print(t.test(age.yy.active,age.yy.failed))
    print(t.test(age.yy.active,age.yy.failed,alternative = 'less'))
    print(t.test(age.yy.active,age.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.yy.active,age.yy.failed)
}
```

A.2 Does AGE change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique company sector names
company.sectors <- unique(aida.age.yy$ATECO.Sector.Name)
table(aida.age.yy$ATECO.Sector.Name)

for(sector.name in company.sectors){
  print("**************************")
  print(sector.name)
  age.yy.active <- aida.age.yy[aida.age.yy$Failed=='No' & aida.age.yy$ATECO.Sector.Name==sector.name ,'Age']
  age.yy.failed <- aida.age.yy[aida.age.yy$Failed=='Yes'& aida.age.yy$ATECO.Sector.Name==sector.name ,'Age']
  
  if( length(age.yy.active)>3 & length(age.yy.failed)>3 ){
    print(t.test(age.yy.active,age.yy.failed))
    print(t.test(age.yy.active,age.yy.failed,alternative = 'less'))
    print(t.test(age.yy.active,age.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.yy.active,age.yy.failed)
}

rm(aida.age.yy)
```

*################*
*##### SIZE #####*
*################*
Company sizes summary
```{r}
# import aida dataset
load("./dataset/aida.size.RData") # reload energy dataset

#summary
skim(aida.size)

#dataset
head(aida.size)
```

Filter sizes of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare size because it has the highest number of samples
table(aida.size$Last.accounting.closing.date)

# Filtering
aida.size.yy <- aida.size[aida.size$Last.accounting.closing.date == 2018,]

rm(aida.size)
```

Some plots of Size in Year 2018
```{r}
# density of Size between failed and active companies at year 2018
ggplot(data=aida.size.yy, aes(x=Total.assetsth.EURLast.avail..yr, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company Sizes in 2018")

```

A. Compare the distributions of SIZE between failed and active companies at a specific year (2018)
```{r}
size.yy.active <- aida.size.yy[aida.size.yy$Failed=='No','Total.assetsth.EURLast.avail..yr']
size.yy.failed <- aida.size.yy[aida.size.yy$Failed=='Yes','Total.assetsth.EURLast.avail..yr']

t.test(size.yy.active,size.yy.failed)
t.test(size.yy.active,size.yy.failed,alternative = 'less')
t.test(size.yy.active,size.yy.failed,alternative = 'greater')

# Remove data from stack
rm(size.yy.active,size.yy.failed)

# RISULTATO
```

A.1 Does SIZE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.size.yy$Legal.form)
table(aida.size.yy$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  size.yy.active <- aida.size.yy[aida.size.yy$Failed=='No' & aida.size.yy$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  size.yy.failed <- aida.size.yy[aida.size.yy$Failed=='Yes'& aida.size.yy$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.yy.active)>3 & length(size.yy.failed)>3 ){
    print(t.test(size.yy.active,size.yy.failed))
    print(t.test(size.yy.active,size.yy.failed,alternative = 'less'))
    print(t.test(size.yy.active,size.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.yy.active,size.yy.failed)
}
```

A.2 Does SIZE change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique legal form values
company.sectors <- unique(aida.size.yy$ATECO.Sector.Name)
table(aida.size.yy$ATECO.Sector.Name)

for(sector.name in company.sectors){
  print("**************************")
  print(sector.name)
  size.yy.active <- aida.size.yy[aida.size.yy$Failed=='No' & aida.size.yy$ATECO.Sector.Name==sector.name ,'Total.assetsth.EURLast.avail..yr']
  size.yy.failed <- aida.size.yy[aida.size.yy$Failed=='Yes'& aida.size.yy$ATECO.Sector.Name==sector.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.yy.active)>3 & length(size.yy.failed)>3 ){
    print(t.test(size.yy.active,size.yy.failed))
    print(t.test(size.yy.active,size.yy.failed,alternative = 'less'))
    print(t.test(size.yy.active,size.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.yy.active,size.yy.failed)
}

rm(aida.size.yy)
```


*###############*
*##### ROI #####*
*###############*
Company rois summary
```{r}
# import aida dataset
load("./dataset/aida.roi.RData") # reload energy dataset

#summary
skim(aida.roi)

#dataset
head(aida.roi)
```

Filter rois of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare roi because it has the highest number of samples
table(aida.roi$Last.accounting.closing.date)

# Filtering
aida.roi.yy <- aida.roi[aida.roi$Last.accounting.closing.date == 2018,]

rm(aida.roi)
```

Some plots of ROI in Year 2018
```{r}
# histogram of ROI between failed and active companies at year 2018
ggplot(data = aida.roi.yy) + 
  geom_histogram(mapping=aes(x=`Return.on.investment.(ROI).(%)%Last.avail..yr`, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed') + 
    ggtitle("Histogram of Company ROIs in 2018")


# density of ROI between failed and active companies at year 2018
ggplot(data=aida.roi.yy, aes(x=`Return.on.investment.(ROI).(%)%Last.avail..yr`, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company ROIs in 2018")
```

A. Compare the distributions of ROI between failed and active companies at a specific year (2018)
```{r}
roi.yy.active <- aida.roi.yy[aida.roi.yy$Failed=='No','Return.on.investment.(ROI).(%)%Last.avail..yr']
roi.yy.failed <- aida.roi.yy[aida.roi.yy$Failed=='Yes','Return.on.investment.(ROI).(%)%Last.avail..yr']

t.test(roi.yy.active,roi.yy.failed)
t.test(roi.yy.active,roi.yy.failed,alternative = 'less')
t.test(roi.yy.active,roi.yy.failed,alternative = 'greater')

# Remove data from stack
rm(roi.yy.active,roi.yy.failed)

# RISULTATO
```

A.1 Does ROI change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(aida.roi.yy$Legal.form)
table(aida.roi.yy$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  roi.yy.active <- aida.roi.yy[aida.roi.yy$Failed=='No' & aida.roi.yy$Legal.form==form.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  roi.yy.failed <- aida.roi.yy[aida.roi.yy$Failed=='Yes'& aida.roi.yy$Legal.form==form.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  
  if( length(roi.yy.active)>3 & length(roi.yy.failed)>3 ){
    print(t.test(roi.yy.active,roi.yy.failed))
    print(t.test(roi.yy.active,roi.yy.failed,alternative = 'less'))
    print(t.test(roi.yy.active,roi.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.yy.active,roi.yy.failed)
}
```

A.2 Does ROI change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique legal form values
company.sectors <- unique(aida.roi.yy$ATECO.Sector.Name)
table(aida.roi.yy$ATECO.Sector.Name)

for(sector.name in company.sectors){
  print("**************************")
  print(sector.name)
  roi.yy.active <- aida.roi.yy[aida.roi.yy$Failed=='No' & aida.roi.yy$ATECO.Sector.Name==sector.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  roi.yy.failed <- aida.roi.yy[aida.roi.yy$Failed=='Yes'& aida.roi.yy$ATECO.Sector.Name==sector.name ,'Return.on.investment.(ROI).(%)%Last.avail..yr']
  
  if( length(roi.yy.active)>3 & length(roi.yy.failed)>3 ){
    print(t.test(roi.yy.active,roi.yy.failed))
    print(t.test(roi.yy.active,roi.yy.failed,alternative = 'less'))
    print(t.test(roi.yy.active,roi.yy.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.yy.active,roi.yy.failed)
}

rm(aida.roi.yy)
```



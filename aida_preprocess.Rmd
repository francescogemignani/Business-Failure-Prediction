---
title: "Risk of Business Failure"
students: F.Gemignani, S.Cucchi, F.Falleni
output: html_notebook
---

Libraries
```{r}
# install.packages("sjmisc")
# devtools::install_github("ropensci/skimr")

library(skimr)       
library(ggplot2)      
library(hrbrthemes)   
library(forcats)      
library(plyr)        
library(plugdensity)  
```

Import & Setup AIDA dataset
```{r}
# clean all
rm(list=ls())

# working dir
wdir_fg = "/Users/francescogemignani/Google Drive/SMD/_Risk-of-business-failure/git"
wdir_ff = "C:/Users/falle/OneDrive - University of Pisa/Data Science/Statistical Methods for Data Science/smdproject2021"
wdir_sc = "/Users/samuele/University/2.SMD/Risk-of-Business-Failure"
setwd(wdir_fg)

# import aida dataset
load(file="../aida.RData")

# For each attribute name, replace all white space whit dot symbol
colnames(aida) <- gsub(" ",".",colnames(aida))
```

Summary
```{r}
skim(aida)
```

Failed
```{r}
# Add 'Failed' feature to AIDA dataset. It describe if a company is failed or not regardless of the cause. In particular a company with Legal status no active has marked with Failed = Yes,,
# otherwise Failed = No when has labeled as Active.

# Missing values don't occour
aida[is.na(aida$Legal.status),]

# Table of Legal status
table(aida$Legal.status)*100/nrow(aida)

# Make the operator
'%!in%' <- function(x,y)!('%in%'(x,y))

# Add new empty column
aida$Failed <- NULL

# For each 'Legal status' which contains 'Active' substring fill in new column 'No' else 'Yes'
act_vector <- c('Active','Active (default of payments)','Active (receivership)')
aida[aida$Legal.status %in% act_vector,'Failed'] <- 'No'
aida[aida$Legal.status %!in% act_vector,'Failed'] <- 'Yes'

aida[is.na(aida$Failed), ]

# Failed info
table(aida$Failed)*100/nrow(aida)
```

Legal Status by Failed
```{r}
table(aida$Failed)*100/nrow(aida)

ggplot(data=aida, aes(x=Failed, fill=Legal.status)) +
  geom_bar() +
  scale_fill_hue(c = 90) 
```

Legal Form by Failed
```{r}
table(aida$Failed)*100/nrow(aida)

ggplot(data=aida, aes(x=Failed, fill=Legal.form)) +
  geom_bar() +
  scale_fill_hue(c = 90) 
```

ATECO Sectors
```{r}
# Add a column with the respective ISTAT sector of the company. In particular first two digits of ATECO 2007code identify the company sector which is an upper case character that began to [A-U] alphabetical range.

#Delete record with ADECO code null (18327)
aida <- aida[!is.na(aida$ATECO.2007code),]

# Add the attribute 'ATECO.Sector.Code' which contain the characters of the sector identified by the first two ATECO 2007 code digits.
aida$ATECO.Sector.Code <- NULL
aida$ATECO.Sector.Code <- substr(aida$ATECO.2007code, 0, 2)

# Make a dataframe called istat.sectors.map, which contains two features:
# 1. ATECO.Sector.Code: first two digits of 'ATECO 2007code'
# 2. ATECO.Sector.Name: the respective sector name of that ATECO.Sector.Code
# Istat sectors can be found in https://www.istat.it/it/archivio/17888

ATECO.Sector.Code <- c('01', '02', '03', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '35', '36', '37', '38', '39', '41', '42', '43', '45', '46', '47', '49', '50', '51', '52', '53', '55', '56', '58', '59', '60', '61', '62', '63', '64', '65', '66', '68', '69', '70', '71', '72', '73', '74', '75', '77', '78', '79', '80', '81', '82', '84', '85', '86', '87', '88', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99', '00')

ATECO.Sector.Name <- c('A', 'A', 'A', 'B', 'B', 'B', 'B', 'B', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'C', 'D', 'E', 'E', 'E', 'E', 'F', 'F', 'F', 'G', 'G', 'G', 'H', 'H', 'H', 'H', 'H', 'I', 'I', 'J', 'J', 'J', 'J', 'J', 'J', 'K', 'K', 'K', 'L', 'M', 'M', 'M', 'M', 'M', 'M', 'M', 'N', 'N', 'N', 'N', 'N', 'N', 'O', 'P', 'Q', 'Q', 'Q', 'R', 'R', 'R', 'R', 'S', 'S', 'S', 'T', 'T','U', 'no.sector')

ATECO.Sector.Description <- c('AGRICOLTURA, SILVICOLTURA E PESCA', 'AGRICOLTURA, SILVICOLTURA E PESCA', 'AGRICOLTURA, SILVICOLTURA E PESCA','ESTRAZIONE DI MINERALI DA CAVE E MINIERE', 'ESTRAZIONE DI MINERALI DA CAVE E MINIERE', 'ESTRAZIONE DI MINERALI DA CAVE E MINIERE', 'ESTRAZIONE DI MINERALI DA CAVE E MINIERE', 'ESTRAZIONE DI MINERALI DA CAVE E MINIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'ATTIVITÀ MANIFATTURIERE', 'FORNITURA DI ENERGIA ELETTRICA, GAS, VAPORE E ARIA CONDIZIONATA', 'FORNITURA DI ACQUA; RETI FOGNARIE, ATTIVITÀ DI GESTIONE DEI RIFIUTI E RISANAMENTO', 'FORNITURA DI ACQUA; RETI FOGNARIE, ATTIVITÀ DI GESTIONE DEI RIFIUTI E RISANAMENTO', 'FORNITURA DI ACQUA; RETI FOGNARIE, ATTIVITÀ DI GESTIONE DEI RIFIUTI E RISANAMENTO', 'FORNITURA DI ACQUA; RETI FOGNARIE, ATTIVITÀ DI GESTIONE DEI RIFIUTI E RISANAMENTO', 'COSTRUZIONI', 'COSTRUZIONI', 'COSTRUZIONI', 'COMMERCIO ALL INGROSSO E AL DETTAGLIO; RIPARAZIONE DI AUTOVEICOLI E MOTOCICLI', 'COMMERCIO ALL INGROSSO E AL DETTAGLIO; RIPARAZIONE DI AUTOVEICOLI E MOTOCICLI', 'COMMERCIO ALL INGROSSO E AL DETTAGLIO; RIPARAZIONE DI AUTOVEICOLI E MOTOCICLI', 'TRASPORTO E MAGAZZINAGGIO', 'TRASPORTO E MAGAZZINAGGIO', 'TRASPORTO E MAGAZZINAGGIO', 'TRASPORTO E MAGAZZINAGGIO', 'TRASPORTO E MAGAZZINAGGIO', 'ATTIVITÀ DEI SERVIZI DI ALLOGGIO E DI RISTORAZIONE', 'ATTIVITÀ DEI SERVIZI DI ALLOGGIO E DI RISTORAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'SERVIZI DI INFORMAZIONE E COMUNICAZIONE', 'ATTIVITÀ FINANZIARIE E ASSICURATIVE', 'ATTIVITÀ FINANZIARIE E ASSICURATIVE', 'ATTIVITÀ FINANZIARIE E ASSICURATIVE', 'ATTIVITÀ IMMOBILIARI', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'ATTIVITÀ PROFESSIONALI, SCIENTIFICHE E TECNICHE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'NOLEGGIO, AGENZIE DI VIAGGIO, SERVIZI DI SUPPORTO ALLE IMPRESE', 'AMMINISTRAZIONE PUBBLICA E DIFESA; ASSICURAZIONE SOCIALE OBBLIGATORIA', 'ISTRUZIONE', 'SANITÀ E ASSISTENZA SOCIALE', 'SANITÀ E ASSISTENZA SOCIALE', 'SANITÀ E ASSISTENZA SOCIALE', 'ATTIVITÀ ARTISTICHE, SPORTIVE, DI INTRATTENIMENTO E DIVERTIMENTO', 'ATTIVITÀ ARTISTICHE, SPORTIVE, DI INTRATTENIMENTO E DIVERTIMENTO', 'ATTIVITÀ ARTISTICHE, SPORTIVE, DI INTRATTENIMENTO E DIVERTIMENTO', 'ATTIVITÀ ARTISTICHE, SPORTIVE, DI INTRATTENIMENTO E DIVERTIMENTO', 'ALTRE ATTIVITÀ DI SERVIZI', 'ALTRE ATTIVITÀ DI SERVIZI', 'ALTRE ATTIVITÀ DI SERVIZI', 'ATTIVITÀ DI FAMIGLIE E CONVIVENZE COME DATORI DI LAVORO PER PERSONALE DOMESTICO', 'ATTIVITÀ DI FAMIGLIE E CONVIVENZE COME DATORI DI LAVORO PER PERSONALE DOMESTICO','ORGANIZZAZIONI ED ORGANISMI EXTRATERRITORIALI', 'no.sector')

istat.sectors.map <- data.frame(ATECO.Sector.Code=ATECO.Sector.Code, ATECO.Sector.Name=ATECO.Sector.Name, ATECO.Sector.Description=ATECO.Sector.Description)

# Merge istat.sectors.map with AIDA dataframe, by ATECO.Sector.Code key
aida <- merge(aida,istat.sectors.map,by="ATECO.Sector.Code")

# Delete ATECO.Sector.Code feature, because we already have the secor name.
aida$ATECO.Sector.Code <- NULL

# Cast ATECO.Sector.Name as Factor
aida$ATECO.Sector.Name <- as.factor(aida$ATECO.Sector.Name)

# Description of ISTAT sectors
# https://www.istat.it/it/archivio/17888
# http://www.fr.camcom.gov.it/sites/default/files/cciaa/RinnovoConsiglio/ateco-2007-struttura.pdf
```

Legal Status Bar Plot
```{r}
#Remove Missing Values
aida <- aida[!is.na(aida$Legal.form),]

table(aida$Legal.status)*100/nrow(aida)

ggplot(data=aida, aes(x=fct_rev(fct_infreq(Legal.status)), fill=Legal.status)) +
  geom_bar() +
  scale_fill_hue(c = 40) +
  theme(legend.position="none") + 
  coord_flip()
```

Legal Form Bar Plot
```{r}
table(aida$Legal.form)*100/nrow(aida)

ggplot(data=aida, aes(x=fct_rev(fct_infreq(Legal.form)), fill=Legal.form)) +
  geom_bar() +
  scale_fill_hue(c = 40) +
  theme(legend.position="none") + 
  coord_flip()
```

#aida[,c("ATECO.2007code","ATECO.Sector.Name","ATECO.Sector.Description","Failed")]

Age
```{r}
# The company age is defined as as the difference between Incorporation.year and Last.accounting.closing.date
age.df <- aida

# Handle Incorporation.year: missing values occour
summary(age.df$Incorporation.year)

# Handle Last.accounting.closing.date:  no missing values
summary(age.df$Last.accounting.closing.date)

# Print the median for each sector of Incorporation.year
tapply(age.df$Incorporation.year,age.df$ATECO.Sector.Name,median, na.rm=TRUE)

# For each ATECO.Sector.Name group replace the 'Incorporation year' nan value with the respective median. In this way the result is more accurate than computing the median on entire Incorporation.year values.
compute.median <- function(x) replace(x, is.na(x), median(x, na.rm = TRUE))
age.df <- ddply(age.df,~ATECO.Sector.Name,transform, Incorporation.year = compute.median(`Incorporation.year`))

# Compute 'Age' attribute
age.df$Age <- age.df$Last.accounting.closing.date - age.df$Incorporation.year
age.df$Age <- as.integer(age.df$Age)
```
```{r}
# Anomalies

# There are some company with negative age, with Incorporation year greater then Last accounting closing date. We suppose that are digit error. Therefore we remove all that records
summary(age.df$Age)
head(age.df[age.df$Age > 35.5,c('Age','Last.accounting.closing.date','Incorporation.year')])

# Remove negative ages
age.df <- age.df[age.df$Age >= 0,]

# Age Anomaly Detection: iqr range approach
iqr <- IQR(age.df$Age)
q1 <- quantile(age.df$Age,0.25)
q3 <- quantile(age.df$Age,0.75)
lower.whisker <- q1 - 1.5*iqr
upper.whisker <- q3 + 1.5*iqr

outliers <- age.df[age.df$Age < lower.whisker | age.df$Age > upper.whisker,'Age']
table(outliers)

boxplot(age.df$Age)
# We decided to don't remove outliers because are not error/noise but companies with higher age. The boxplot shows that the age between the median and the maximum age is sparse.
```
```{r}
ggplot(data = age.df) + 
  geom_histogram(mapping=aes(x=Age, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed')
```

Size
```{r}
# Il legislatore attribuisce la dimensione di un'azienda in base al totale degli elementi che costituiscono l'attivo dello stato patrimoniale, al risultato di esercizio ed al numero di dipendenti. Nel nostro caso abbiamo deciso di attribuire a size il totale delle attività dello sp, in particolare abbiamo considerato il totale degli assets nell'ultimo anno disponibile per esprimere il valore  degli impieghi di un'azienda. 
size.df <- aida

# We consider all the company without nan value in total assets last available.
size.df <- size.df[!is.na(size.df$Total.assetsth.EURLast.avail..yr),]
summary(size.df$Total.assetsth.EURLast.avail..yr)
```

```{r}
# Anomaly detection

# Before outliers detection
boxplot(size.df$Total.assetsth.EURLast.avail..yr)
plot(density(size.df$Total.assetsth.EURLast.avail..yr))

# Size Anomaly Detection: iqr range approach
iqr <- IQR(size.df$Total.assetsth.EURLast.avail..yr)
q1 <- quantile(size.df$Total.assetsth.EURLast.avail..yr,0.25)
q3 <- quantile(size.df$Total.assetsth.EURLast.avail..yr,0.75)
lower.whisker <- q1 - 1.5*iqr
upper.whisker <- q3 + 1.5*iqr

# Remove all outliers not between [q1-1.5*iqr,q3+1.5*iqr] (external from two whiskers)
size.df <- size.df[size.df$Total.assetsth.EURLast.avail..yr >= lower.whisker & size.df$Total.assetsth.EURLast.avail..yr <= upper.whisker,]

#After outliers detection
boxplot(size.df$Total.assetsth.EURLast.avail..yr)
plot(density(size.df$Total.assetsth.EURLast.avail..yr))
```
```{r}
# ggplot2 size plots

ggplot( data=size.df, aes(x=Total.assetsth.EURLast.avail..yr) ) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)

ggplot(data=size.df, aes(x=Total.assetsth.EURLast.avail..yr, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum()
```

ROI: Return on Investments
```{r}
# Reduce the aida dataset from all that companies which report ROI of all last three years. Obviously all missing values are been deleted. The dataset is composed by 386.629 companies (20.61%)
roi.df <- aida
colnames(roi.df)[65:67] <- c('ROI.last.avail','ROI.one.year.ago','ROI.two.years.ago')

b<- nrow(roi.df)
roi.df <- roi.df[!is.na(roi.df$ROI.last.avail),]
roi.df <- roi.df[!is.na(roi.df$ROI.one.year.ago),]
roi.df <- roi.df[!is.na(roi.df$ROI.two.years.ago),]
a <- nrow(roi.df)
ratio <- a*100/b

# Add attribute avg.roi which rappresents the average ROI of the last three years.
roi.df$avg.roi <- (roi.df$ROI.last.avail + roi.df$ROI.one.year.ago + roi.df$ROI.two.years.ago)/3

summary(roi.df$avg.roi)
```
```{r}
# ROI Anomaly Detection: iqr range approach
iqr <- IQR(roi.df$avg.roi)
q1 <- quantile(roi.df$avg.roi,0.25)
q3 <- quantile(roi.df$avg.roi,0.75)
lower.whisker <- q1 - 1.5*iqr
upper.whisker <- q3 + 1.5*iqr

outliers <- roi.df[roi.df$avg.roi < lower.whisker | roi.df$avg.roi > upper.whisker,c('avg.roi')]
#table(outliers)
boxplot(roi.df$avg.roi)

# The outliers are companies with the higher and lower roi. We don't remove these record because the roi dataset composed only from 20.61% of record and could be usefull.
```
```{r}
ggplot(data = roi.df) + 
  geom_histogram(mapping=aes(x=avg.roi, fill=Failed),binwidth = 1,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed')
```


Solvency Ratio
```{r}
summary(aida$`Solvency.ratio.(%)%Last.avail..yr`)

# Deleting missing values
solvency.df <- aida

b<- nrow(solvency.df)
solvency.df <- solvency.df[!is.na(solvency.df$`Solvency.ratio.(%)%Last.avail..yr`),]
solvency.df <- solvency.df[!is.na(solvency.df$`Solvency.ratio.(%)%Year.-.1`),]
solvency.df <- solvency.df[!is.na(solvency.df$`Solvency.ratio.(%)%Year.-.2`),]
a <- nrow(solvency.df)
ratio <- a*100/b

# Add attribute avg.size which rappresents the average size of the last three years.
solvency.df$avg.solvency <- round((solvency.df$`Solvency.ratio.(%)%Last.avail..yr`
                              + solvency.df$`Solvency.ratio.(%)%Year.-.1` + solvency.df$`Solvency.ratio.(%)%Year.-.2`)/3)

summary(solvency.df$avg.solvency)
```
```{r}
# ROI Anomaly Detection: iqr range approach
iqr <- IQR(solvency.df$avg.solvency)
q1 <- quantile(solvency.df$avg.solvency,0.25)
q3 <- quantile(solvency.df$avg.solvency,0.75)
lower.whisker <- q1 - 1.5*iqr
upper.whisker <- q3 + 1.5*iqr

outliers <- solvency.df[solvency.df$avg.solvency < lower.whisker | solvency.df$avg.solvency > upper.whisker,c('avg.solvency')]
#table(outliers)
boxplot(solvency.df$avg.solvency)

# The avg.solvency distribution is well balanced and doesn't show any anomaly
```
```{r}
ggplot(data = solvency.df) + 
  geom_histogram(mapping=aes(x=avg.solvency, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed')
```



QUESTION A
Compare the distributions of size/age/other between failed and active companies at a specific year?

1.Abbiamo definito age, size°, roi° e solvency.ratio°.     ° = media sui 3 anni precedenti
  - Quali e quante variabili dobbiamo confrontare nella domanda A? 
  - Cosa intende per specific year? Devo filtrare un anno specifico quindi ridimensionare il dataset?

2. siamo in grado di rispondere alla domanda A nello stato in cui ci troviamo adesso?
  - Posso utilizzare ad esempio un approccio non parametrico come la KDE appena vista a lezione per rispondere alle domande?
  - fhat = kde.boundary(x=age,xmin=0, xmax=118,boundary.kernel="beta") su age non termina più...
  - se uso density(age) mi restituisce cmq una boundary kde? il bandwitch sceglie quello ottimale?

3. Se metto la densità (freq = False) la somma delle densità torna sempre un valore diverso 
hist(age.df$Age,freq=FALSE,breaks=1)   #la somma della densità ritorna 1
hist(age.df$Age,freq=FALSE,breaks=120) #la somma della densità ritorna 100
hist(age.df$Age,freq=FALSE,breaks=11,ylim=c(0.0,1.0)) #la somma della densità ritorna 0.1
hist(age.df$Age,freq=FALSE,breaks="Sturges") #la somma della densità ritorna ?


4. la anomaly dectection vista a lezione (IQR range) mi permette di trovare/eliminare gli outliers all'esterno degli intervalli <Q1-1.5*IQR e >Q3+1.5 IQR. E' necessario determinare le anomalie per rispondere alle domande A e B o è più utile eliminarle solo quando facciamo la regressione (sensibile agli outliers)?
Perchè dopo aver eliminato le anomalie all esterno dei whiskers se rieseguo il boxplot sulla nuova variabile si ripresentano ancora anomalie?

5. stesso discorso feature reduction. Non ha senso per le domande a e b, in tali casi eseguo il preprocess solo degli attributi che sto considerando. Ha senso farla solo nel caso della regressione nel nostro caso?

6. istogrammii e grafi preferisce con ggplot2 o con le funzioni (hist,barplot,lines...) viste a lezione? I grafici con ggplot2 sono belli ma non mi permettono ad esempio di avere il pieno controllo...esempio bandwitch, binsize ecc...

---
title: "Question A"
output: html_notebook
---

Setup
```{r}
library(skimr)  
library(ggplot2)
library(hrbrthemes)   
library(forcats)  

# clean all
rm(list=ls())

# working dir
wdir_fg = "/Users/francescogemignani/Google Drive/SMD/_Risk-of-business-failure/git"
wdir_ff = "C:/Users/falle/OneDrive - University of Pisa/Data Science/Statistical Methods for Data Science/smdproject2021"
wdir_sc = "/Users/samuele/University/2.SMD/Risk-of-Business-Failure"
setwd(wdir_fg)
```


*########################################## QUESTION A ################################################*
*A.  Compare the distributions of age/size/roi between failed and active companies at a specific year*
*A.1 Does it change for a specific company form (i.e. SPA,SRL,etc)?*
*A.2 Does it change for a specific industry sector (see ATECO sectors)?*
*######################################################################################################*

*###############*
*##### AGE #####*
*###############*
Company ages summary
```{r}
# import aida dataset
load("./dataset/age_df.RData") # reload energy dataset

#summary
skim(age.df)

#dataset
head(age.df)
```

Filter ages of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare age because it has the highest number of samples
table(age.df$Last.accounting.closing.date)

# Filtering
age.df.2018 <- age.df[age.df$Last.accounting.closing.date == 2018,]
```

Some plots of Age in Year 2018
```{r}

##### AGE
# histogram of age between failed and active companies at year 2018
ggplot(data = age.df.2018) + 
  geom_histogram(mapping=aes(x=Age, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed') + 
    ggtitle("Histogram of Company ages in 2018")

# density of age between failed and active companies at year 2018
ggplot(data=age.df.2018, aes(x=Age, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company ages in 2018")

```

A. Compare the distributions of AGE between failed and active companies at a specific year (2018)
```{r}
age.2018.active <- age.df.2018[age.df.2018$Failed=='No','Age']
age.2018.failed <- age.df.2018[age.df.2018$Failed=='Yes','Age']

t.test(age.2018.active,age.2018.failed)
t.test(age.2018.active,age.2018.failed,alternative = 'less')
t.test(age.2018.active,age.2018.failed,alternative = 'greater')

# Remove data from stack
rm(age.2018.active,age.2018.failed)

# RISULTATO
# Il p-value dell'ipotesi nulla non è significativo perchè è molto basso. Di conseguenza scarto l'ipotesi nulle e considero solo quelle bilaterali, in particolare
# l'ipotesi bilateriale superiore. In tal caso il p-value è pari a 1, e questo ci porta ad accettare l'ipotesi bilaterale superiore, ovvero che la media dell'età
# dell'età delle aziende attive è superiore alla media delle età delle aziende fallite (nel 2018).  
# Quindi nel 2018 le aziende attive sono più vecchie di quelle fallite
```

A.1 Does AGE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(age.df.2018$Legal.form)
table(age.df.2018$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  age.2018.active <- age.df.2018[age.df.2018$Failed=='No' & age.df.2018$Legal.form==form.name ,'Age']
  age.2018.failed <- age.df.2018[age.df.2018$Failed=='Yes'& age.df.2018$Legal.form==form.name ,'Age']
  
  if( length(age.2018.active)>3 & length(age.2018.failed)>3 ){
    print(t.test(age.2018.active,age.2018.failed))
    print(t.test(age.2018.active,age.2018.failed,alternative = 'less'))
    print(t.test(age.2018.active,age.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.2018.active,age.2018.failed)
}
```

A.2 Does AGE change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique legal form values
company.forms <- unique(age.df.2018$ATECO.Sector.Name)
table(age.df.2018$ATECO.Sector.Name)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  age.2018.active <- age.df.2018[age.df.2018$Failed=='No' & age.df.2018$ATECO.Sector.Name==form.name ,'Age']
  age.2018.failed <- age.df.2018[age.df.2018$Failed=='Yes'& age.df.2018$ATECO.Sector.Name==form.name ,'Age']
  
  if( length(age.2018.active)>3 & length(age.2018.failed)>3 ){
    print(t.test(age.2018.active,age.2018.failed))
    print(t.test(age.2018.active,age.2018.failed,alternative = 'less'))
    print(t.test(age.2018.active,age.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(age.2018.active,age.2018.failed)
}
```

*################*
*##### SIZE #####*
*################*
Company sizes summary
```{r}
# import aida dataset
load("./dataset/size_df.RData") # reload energy dataset

#summary
skim(size.df)

#dataset
head(size.df)
```

Filter sizes of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare size because it has the highest number of samples
table(size.df$Last.accounting.closing.date)

# Filtering
size.df.2018 <- size.df[size.df$Last.accounting.closing.date == 2018,]
```

Some plots of Size in Year 2018
```{r}
# density of Size between failed and active companies at year 2018
ggplot(data=size.df.2018, aes(x=Total.assetsth.EURLast.avail..yr, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company Sizes in 2018")

```

A. Compare the distributions of SIZE between failed and active companies at a specific year (2018)
```{r}
size.2018.active <- size.df.2018[size.df.2018$Failed=='No','Total.assetsth.EURLast.avail..yr']
size.2018.failed <- size.df.2018[size.df.2018$Failed=='Yes','Total.assetsth.EURLast.avail..yr']

t.test(size.2018.active,size.2018.failed)
t.test(size.2018.active,size.2018.failed,alternative = 'less')
t.test(size.2018.active,size.2018.failed,alternative = 'greater')

# Remove data from stack
rm(size.2018.active,size.2018.failed)

# RISULTATO
```

A.1 Does SIZE change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(size.df.2018$Legal.form)
table(size.df.2018$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  size.2018.active <- size.df.2018[size.df.2018$Failed=='No' & size.df.2018$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  size.2018.failed <- size.df.2018[size.df.2018$Failed=='Yes'& size.df.2018$Legal.form==form.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.2018.active)>3 & length(size.2018.failed)>3 ){
    print(t.test(size.2018.active,size.2018.failed))
    print(t.test(size.2018.active,size.2018.failed,alternative = 'less'))
    print(t.test(size.2018.active,size.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.2018.active,size.2018.failed)
}
```

A.2 Does SIZE change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique legal form values
company.forms <- unique(size.df.2018$ATECO.Sector.Name)
table(size.df.2018$ATECO.Sector.Name)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  size.2018.active <- size.df.2018[size.df.2018$Failed=='No' & size.df.2018$ATECO.Sector.Name==form.name ,'Total.assetsth.EURLast.avail..yr']
  size.2018.failed <- size.df.2018[size.df.2018$Failed=='Yes'& size.df.2018$ATECO.Sector.Name==form.name ,'Total.assetsth.EURLast.avail..yr']
  
  if( length(size.2018.active)>3 & length(size.2018.failed)>3 ){
    print(t.test(size.2018.active,size.2018.failed))
    print(t.test(size.2018.active,size.2018.failed,alternative = 'less'))
    print(t.test(size.2018.active,size.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(size.2018.active,size.2018.failed)
}
```


*###############*
*##### ROI #####*
*###############*
Company rois summary
```{r}
# import aida dataset
load("./dataset/roi_df.RData") # reload energy dataset

#summary
skim(roi.df)

#dataset
head(roi.df)
```

Filter rois of all companies for a specific year (2018)
```{r}
# We have selected year equal to 2018 to compare roi because it has the highest number of samples
table(roi.df$Last.accounting.closing.date)

# Filtering
roi.df.2018 <- roi.df[roi.df$Last.accounting.closing.date == 2018,]
```

Some plots of ROI in Year 2018
```{r}
# histogram of ROI between failed and active companies at year 2018
ggplot(data = roi.df.2018) + 
  geom_histogram(mapping=aes(x=`Return.on.investment.(ROI).(%)%Last.avail..yr`, fill=Failed),binwidth = 2,color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"))+
    theme_ipsum() +
    labs(fill='Failed') + 
    ggtitle("Histogram of Company ROIs in 2018")


# density of ROI between failed and active companies at year 2018
ggplot(data=roi.df.2018, aes(x=`Return.on.investment.(ROI).(%)%Last.avail..yr`, group=Failed, fill=Failed)) +
    geom_density(adjust=1.5, alpha=.4) +
    theme_ipsum() + 
    ggtitle("Density of Company ROIs in 2018")
```

A. Compare the distributions of ROI between failed and active companies at a specific year (2018)
```{r}
roi.2018.active <- roi.df.2018[roi.df.2018$Failed=='No','Return.on.investment.(ROI).(%)%Last.avail..yr']
roi.2018.failed <- roi.df.2018[roi.df.2018$Failed=='Yes','Return.on.investment.(ROI).(%)%Last.avail..yr']

t.test(roi.2018.active,roi.2018.failed)
t.test(roi.2018.active,roi.2018.failed,alternative = 'less')
t.test(roi.2018.active,roi.2018.failed,alternative = 'greater')

# Remove data from stack
rm(roi.2018.active,roi.2018.failed)

# RISULTATO
```

A.1 Does ROI change for a specific company form (i.e. SPA,SRL,etc)?
```{r}
# List of unique legal form values
company.forms <- unique(roi.df.2018$Legal.form)
table(roi.df.2018$Legal.form)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  roi.2018.active <- roi.df.2018[roi.df.2018$Failed=='No' & roi.df.2018$Legal.form==form.name ,`Return.on.investment.(ROI).(%)%Last.avail..yr`]
  roi.2018.failed <- roi.df.2018[roi.df.2018$Failed=='Yes'& roi.df.2018$Legal.form==form.name ,`Return.on.investment.(ROI).(%)%Last.avail..yr`]
  
  if( length(roi.2018.active)>3 & length(roi.2018.failed)>3 ){
    print(t.test(roi.2018.active,roi.2018.failed))
    print(t.test(roi.2018.active,roi.2018.failed,alternative = 'less'))
    print(t.test(roi.2018.active,roi.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.2018.active,roi.2018.failed)
}
```

A.2 Does ROI change for a specific industry sector (see ATECO sectors)?
```{r}
# List of unique legal form values
company.forms <- unique(roi.df.2018$ATECO.Sector.Name)
table(roi.df.2018$ATECO.Sector.Name)

for(form.name in company.forms){
  print("**************************")
  print(form.name)
  roi.2018.active <- roi.df.2018[roi.df.2018$Failed=='No' & roi.df.2018$ATECO.Sector.Name==form.name ,`Return.on.investment.(ROI).(%)%Last.avail..yr`]
  roi.2018.failed <- roi.df.2018[roi.df.2018$Failed=='Yes'& roi.df.2018$ATECO.Sector.Name==form.name ,`Return.on.investment.(ROI).(%)%Last.avail..yr`]
  
  if( length(roi.2018.active)>3 & length(roi.2018.failed)>3 ){
    print(t.test(roi.2018.active,roi.2018.failed))
    print(t.test(roi.2018.active,roi.2018.failed,alternative = 'less'))
    print(t.test(roi.2018.active,roi.2018.failed,alternative = 'greater'))
    }
  else print("Non ci sono abbastanza osservazioni")
  
  # Remove data from stack
  rm(roi.2018.active,roi.2018.failed)
}
```


DOMANDE
1. last available e last accounting year
2. se il p value dell'ipotesi nulla è > 0.05 allora le ipotesi bilaterali nn le considero?




*########################################## QUESTION A CTD ################################################*
*A.  Compare the distributions of age/size/roi of failed companies over time*
*A.1 Does it change for a specific company form (i.e. SPA,SRL,etc)?*
*A.2 Does it change for a specific location (i.e. Tuscany,Lombardy,etc.)?*
*##########################################################################################################*

*###############*
*##### AGE #####*
*###############*

*###############*
*##### SIZE ####*
*###############*

*###############*
*##### ROI #####*
*###############*

